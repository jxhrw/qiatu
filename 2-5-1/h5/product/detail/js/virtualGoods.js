$(document).ready(function(){sessionStorage.setItem("toOrderLeave",0);sessionStorage.setItem("paymentLeave",0);var a=1,b,c,d,e,f,g,h,j,k,l,m,n,o,p=[],q,r,s,t,u,v,w=0,x,y;assetType=GetParams().assettype?GetParams().assettype:GetParams().assetType;couponId=GetParams().couponid?GetParams().couponid:GetParams().couponId;couponCode=GetParams().couponcode?GetParams().couponcode:GetParams().couponCode;var z=$(window).width();var A;if(/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&/jihe/i.test(navigator.userAgent)){A="jiheios"};var B=0,C=0,D=0,E=0,F=0;var G;function iosBridgeObjc(J){var K;K=document.createElement("iframe");K.setAttribute("src",J);K.setAttribute("style","display:none;");document.body.appendChild(K);K.parentNode.removeChild(K)};$(".chooseBox").css("z-index","9");pickInformation();if(/android/i.test(navigator.userAgent)){$(".reduce").css("line-height","1.9rem");$(".add").css("line-height","1.9rem")};if(/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)){$(".chooseBox .number").focus(function(){if($(".chooseBox").css("position")=="fixed"){setTimeout(function(){$("#cheng").css("height","3.33rem");$(".chooseBox").css({"position":"absolute","top":$("body").scrollTop(),"-webkit-box-shadow":"0 0 10px #dcdada","-moz-box-shadow":"0 0 10px #dcdada","box-shadow":"0 0 10px #dcdada"})},100)};$(".footer").css({"position":"absolute"});$(window).scroll(function(){var J=$(".packageName").height();var K=$(".packageName").offset().top-$("body").scrollTop();if(K+J<=0){$("#cheng").css("height","3.33rem");$(".chooseBox").css({"position":"absolute","top":$("body").scrollTop(),"-webkit-box-shadow":"0 0 10px #dcdada","-moz-box-shadow":"0 0 10px #dcdada","box-shadow":"0 0 10px #dcdada"})}else{$("#cheng").css("height","0");$(".chooseBox").css({"position":"relative","top":"0","-webkit-box-shadow":"none","-moz-box-shadow":"none","box-shadow":"none"})}})}).blur(function(){if($(".chooseBox").css("position")=="fixed"||$(".chooseBox").css("position")=="absolute"){$("#cheng").css("height","3.33rem");$(".chooseBox").css({"position":"fixed","top":"0","-webkit-box-shadow":"0 0 10px #dcdada","-moz-box-shadow":"0 0 10px #dcdada","box-shadow":"0 0 10px #dcdada"})}else{$("#cheng").css("height","0");$(".chooseBox").css({"position":"relative","top":"0","-webkit-box-shadow":"none","-moz-box-shadow":"none","box-shadow":"none"})};$(".footer").css({"position":"fixed"});scrollS()})};$(window).scroll(function(){scrollS()});$(window).on("touchmove",function(){scrollS()});function scrollS(){var J=$(".packageName").height();var K=$(".packageName").offset().top-$("body").scrollTop();if(K+J<=0){$("#cheng").css("height","3.33rem");$(".chooseBox").css({"position":"fixed","top":"0","-webkit-box-shadow":"0 0 10px #dcdada","-moz-box-shadow":"0 0 10px #dcdada","box-shadow":"0 0 10px #dcdada"})}else{$("#cheng").css("height","0");$(".chooseBox").css({"position":"relative","top":"0","-webkit-box-shadow":"none","-moz-box-shadow":"none","box-shadow":"none"})}};var H,I;$('body').on('touchstart',function(J){var K=J.originalEvent.targetTouches[0];H=K.pageY});$('body').on('touchmove',function(J){var K=J.originalEvent.changedTouches[0];I=K.pageY});$('body').on('touchend',function(J){if($("body").scrollTop()<=0){if(I-H>30){pickInformation();I=0;H=0}}});if($(".numberBox .number").val()<=1){$(".numberBox .reduce").attr("disabled","false").css("background-color","#f3cbcb")};$(".numberBox .add").click(function(){var J=$(".numberBox .number").val();if(J*1+1>k*1&&k*1!=-1){$(".smallBomb").html("商品库存不足").show();setTimeout(function(){$(".smallBomb").html("").hide()},2000);$(".numberBox .number").val(a)}else{if(b>0){if(J*1>=d*1){$(".smallBomb").html("每人最多可购买"+b+"份").show();setTimeout(function(){$(".smallBomb").html("").hide()},2000);$(".numberBox .number").val(a);return}};a=J*1+1;$(".numberBox .number").val(a);if(u==31){var K=$(".schedule ul li").length;for(var L=0;L<K;L++){$(".schedule ul li").eq(L).find("span").html(floatFixed2(p[L]*a))};if(h>0){$(".price span").html(showCyCode+floatFixed2(showTotalPrice*a)+showCyUnit)}};if(h>0&&j>0){$(".footer div:first-child span").html("￥"+floatFixed2(h*a)+","+floatFixed2(j*a)+"积分")}else{$(".footer div:first-child span").html(showCyCode+floatFixed2(showTotalPrice*a)+showCyUnit)};$(".numberBox .reduce").css("background-color","#ec6969")}});$(".numberBox .reduce").click(function(){var J=$(".numberBox .number").val();if(J<=1){$(this).attr("disabled","false").css("background-color","#f3cbcb")}else{a=J*1-1;if(a<=1){$(this).attr("disabled","false").css("background-color","#f3cbcb")};$(".numberBox .number").val(a);if(u==31){var K=$(".schedule ul li").length;for(var L=0;L<K;L++){$(".schedule ul li").eq(L).find("span").html(floatFixed2(p[L]*a))};if(h>0){$(".price span").html(showCyCode+floatFixed2(showTotalPrice*a)+showCyUnit)}};if(h>0&&j>0){$(".footer div:first-child span").html("￥"+floatFixed2(h*a)+","+floatFixed2(j*a)+"积分")}else{$(".footer div:first-child span").html(showCyCode+floatFixed2(showTotalPrice*a)+showCyUnit)}}});$(".numberBox .number").blur(function(){var J=$(this).val();if(J<=0||J.indexOf(".")>-1||isNaN(J)){$(".footer div").addClass("disabled");$(".smallBomb").html("数量必须为正整数").show();setTimeout(function(){$(".smallBomb").html("").hide();$(".footer div").removeClass("disabled")},2000);$(this).val(a)}else{if(J*1>k&&k*1!=-1){$(".footer div").addClass("disabled");$(".smallBomb").html("商品库存不足").show();setTimeout(function(){$(".smallBomb").html("").hide();$(".footer div").removeClass("disabled")},2000);$(".numberBox .number").val(a)}else{if(b>0){if(J*1>b*1){$(".footer div").addClass("disabled");$(".smallBomb").html("每人最多可购买"+b+"份").show();setTimeout(function(){$(".smallBomb").html("").hide();$(".footer div").removeClass("disabled")},2000);$(".numberBox .number").val(a);return}};a=J*1;$(".numberBox .number").val(a);if(u==31){var K=$(".schedule ul li").length;for(var L=0;L<K;L++){$(".schedule ul li").eq(L).find("span").html(floatFixed2(p[L]*a))};if(h>0){$(".price span").html(showCyCode+floatFixed2(showTotalPrice*a)+showCyUnit)}};if(h>0&&j>0){$(".footer div:first-child span").html("￥"+floatFixed2(h*a)+","+floatFixed2(j*a)+"积分")}else{$(".footer div:first-child span").html(showCyCode+floatFixed2(showTotalPrice*a)+showCyUnit)};if(a==1){$(".numberBox .reduce").css("background-color","#f3cbcb")};if(a>1){$(".numberBox .reduce").css("background-color","#ec6969")}}}});$(".handNum input").blur(function(){var J=$(this).val();if(J<=0||J.indexOf(".")>-1||isNaN(J)){$(".smallBomb").html("数量必须为正整数").show();setTimeout(function(){$(".smallBomb").html("").hide()},2000);$(this).val(a)}else{if(b>0){if(J*1>b*1){$(".smallBomb").html("每人最多可购买"+b+"份").show();setTimeout(function(){$(".smallBomb").html("").hide()},2000);$(".numberBox .number").val(a);return}};a=J*1;$(".numberBox .number").val(a);if(h>0&&j>0){$(".footer div:first-child span").html("￥"+floatFixed2(h*a)+","+floatFixed2(j*a)+"积分")}else{$(".footer div:first-child span").html(showCyCode+floatFixed2(showTotalPrice*a)+showCyUnit)}}});$(".payBoxShadow").css("height",$(window).height());$(".shadow").css("height",$(window).height()-$(".payBox").height()).click(function(){$(".payBoxShadow").hide();$(".know").show()});$(".title span,.know").click(function(){$(".payBoxShadow").hide();$(".know").show()});$("#hasOrder").click(function(){$(".payBoxShadow").hide();$(".notPay").hide()});$("#iknow").click(function(){$(".payBoxShadow").hide()});$("#buyIntegral").click(function(){window.location.href="/html/order/virtualGoods.html?id=38607&mc=zqjf"});function GetParams(){var J=window.location.search;var K={};if(J.indexOf("?")!=-1){J=J.substr(1);paramArray=J.split("&");for(var L=0;L<paramArray.length;L++){kv=paramArray[L].split("=");K[kv[0]]=kv[1]}};return K};function zero(J){if(J<10){return"0"+J}else{return J}};function getTime(J){var K=new Date(parseInt(J));var L,M,N,O,P;L=K.getFullYear();M=K.getMonth()+1;N=K.getDate();O=K.getHours();P=K.getMinutes();return L+"-"+zero(M)+"-"+zero(N)+" "+zero(O)+":"+zero(P)};function pickInformation(){var J=GetParams().id;var K={id:J};if(undefined!=assetType){K.assetType=assetType};if(undefined!=couponId){K.couponId=couponId};$.ajax({url:"/product/h5/query",type:'POST',data:{data:JSON.stringify(K)},dataType:'json',success:function(L){console.log(L);if(L.sc==0){b=L.data.maxBuyQuantity*1;e=L.data.groupBuyingThreshold*1;g=L.data.expiredTime;h=L.data.productPrice.totalPrice/100;j=L.data.productPrice.totalPointPrice*1;y=L.data.sellingRuleList;k=L.data.tolAmount*1;n=L.data.productName;q=L.data.sellAmount*1;t=L.data.serviceInfoList;r=L.data.payChannelList;x=L.data.sellingRulesDesc;u=L.data.objectType;v=L.data.cancelPolicy;w=L.data.saleEndtime;showCyCode=L.data.productPrice.showCyCode?L.data.productPrice.showCyCode:"";showCyUnit=L.data.productPrice.showCyUnit?L.data.productPrice.showCyUnit:"";showTotalPrice=L.data.productPrice.showTotalPrice?L.data.productPrice.showTotalPrice:0;showCyType=L.data.productPrice.showCyType?L.data.productPrice.showCyType:0;if(showCyType=="0"||showCyType=="5"){showTotalPrice=showTotalPrice/100};if(L.data.priceType=="1"){$("#jfBuy").show()}else{$("#jfBuy").hide()};if(L.data.objectType==31){$(".price").html("存入本金：<span></span><a id='needDeposit'></a>");if(e<=1){$(".infoPay").show()}};if(undefined!=L.data.additionalInfo){$("#needDeposit").html("（"+L.data.additionalInfo+"）")};var M="{'productIdList':["+J+"]}";var N;if(A==undefined){N="/order/h5/count"}else if(A=="jiheios"){N="/order/client/count"};$.post(N,{data:M},function(O){console.log(O);var P=O.data[J].paidQuantity*1;if(O.sc=="0"){if(undefined!=O.data[J].mypaidQuantity){c=O.data[J].mypaidQuantity}else{c=0};$("#personNum").html(O.data[J].paidUsercount);$("#personMon").html(floatFixed2(O.data[J].paidAmount/1e6)+"万元")}else{c=0};d=b-c*1;if(L.data.objectType!=31){$(".footer div:last-child").html("购买")};if("4"==L.data.status){$(".footer div:last-child").css({"background":"#c8cacc","border-top-color":"#c8cacc","border-bottom-color":"#c8cacc"}).addClass("disabled").html("即将开始")}else if(k==0&&undefined!=P&&P<q){var S='<p style="position: absolute;width:100%;top: -1.67rem;;height:1.67rem;line-height:1.67rem;background-color: #ec6969;color: #fff;text-align: center;font-size: 0.9rem;padding: 0;">有人还未付款，若30分钟内仍未付款，您将有认购机会</p>';var T=$(".footer div:first-child").html()+S;$(".footer div:first-child").html(T);$(".footer div:last-child").css({"background":"#828d9a","border-top-color":"#828d9a","border-bottom-color":"#828d9a"}).html("还有认购机会")}else if(k==0&&undefined!=P&&P==q){$(".footer div:last-child").css({"background":"#c8cacc","border-top-color":"#c8cacc","border-bottom-color":"#c8cacc"}).addClass("disabled").html("已售罄")};for(var Q=0;Q<r.length;Q++){if(r[Q]=="mz"){F=1};if(r[Q]=="wx"){B=1};if(r[Q]=="wx_pub"){C=1};if(r[Q]=="alipay"){D=1};if(r[Q]=="alipay_pub"){E=1}};$(".packageName").html(n);var R=$(".numberBox input").val();document.title=L.data.productName;if(e>1){var S=parseInt(q/e*100);$("#speed span").html(S+"%");$(".line").css("width",S+"%");$(".schedule,.intoGroup,.endTime").show();$(".endTime span").html(getTime(w));$("#speed").css("margin-left",-$("#speed").width()/2-0.2*z/25);$(".scheduleLineBox").css("padding-bottom","1.5rem");if(h>0){$("#target span").html(e*h/1e4+"万")};if(j>0){$("#target span").html(e*j/1e4+"万")};$(".scheduleLine,#target").css("width","100%");$("#speed").css("left",S+"%");if(S>100){$("#speed").css("left","100%")};if(h>0){$("#has em").html(q*h/1e4+"万元")}else if(j>0){$("#has em").html(q*j/1e4+"万积分")};if(k!=-1){if(e<(k+q)){if(h>0){$("#have").show().find("em").html((k+q)*h/1e4+"万元")}else if(j>0){$("#have").show().find("em").html((k+q)*j/1e4+"万积分")}}}};$(".titleChart").attr("src",L.data.imgs+'?imageView2/1/w/750/h/480');$(".price span").html(showCyCode+showTotalPrice+showCyUnit);if(showCyType=="4"||showCyType=="5"){$(".footer div:first-child span").html(showTotalPrice+showCyUnit)}else{$(".footer div:first-child span").html(showCyCode+showTotalPrice+showCyUnit)};if(h>0&&j>0){}else if(h>0){o=h}else if(j>0){};$(".details").html(L.data.productDesc);if(L.data.objectType==31){$(".schedule,.schedule ul").show();var S=$(".schedule ul li").eq(0).html();S="";p=[];var T=[];for(var U=0;undefined!=t&&U<t.length;U++){if(t[U].type=="4"||t[U].type=="3"){var V=0;for(var W=0;W<T.length;W++){if(T[W].type==t[U].type){T[W].serviceValue=T[W].serviceValue*1+t[U].serviceValue*1;V++}};if(V==0){T.push({"type":t[U].type,"serviceName":t[U].serviceName,"serviceValue":t[U].serviceValue})}}};for(var U=0;U<T.length;U++){p.push(T[U].serviceValue/100);S=S+'<li>'+T[U].serviceName+'<p class="fr">￥<span>'+a*T[U].serviceValue/100+'</span></p></li>'};$(".schedule ul").html(S);if($(".schedule ul li").length==0&&$(".intoGroup").css("display")=="none"&&$(".endTime").css("display")=="none"){$(".schedule,.schedule ul").hide()}};$(".footer div:last-child").click(function(){var S={"productid":J};var T='/order/h5/list';$.post(h5orClient(T),{data:JSON.stringify(S)},function(U){if(U.sc=="0"){if(undefined!=U.data&&U.data.length>0){$("#hasOrder").show();$(".notPay").show();$(".notPayLook").click(function(){window.location.href="/html/order/orderDetailN.html?orderid="+U.data[0].orderid})}else{payment()}}else{payment()}})})})}},error:function(L){console.log(L.status)}})};function payment(){var J=GetParams().id;var K={id:J};if(undefined!=assetType){K.assetType=assetType};if(undefined!=couponId){K.couponId=couponId};$.ajax({url:"/product/h5/query",type:'POST',data:{data:JSON.stringify(K)},dataType:'json',success:function(L){if(L.sc==0){b=L.data.maxBuyQuantity*1;e=L.data.groupBuyingThreshold*1;g=L.data.expiredTime;h=L.data.productPrice.totalPrice/100;j=L.data.productPrice.totalPointPrice*1;y=L.data.sellingRuleList;k=L.data.tolAmount*1;n=L.data.productName;q=L.data.sellAmount*1;t=L.data.serviceInfoList;r=L.data.payChannelList;x=L.data.sellingRulesDesc;u=L.data.objectType;v=L.data.cancelPolicy;w=L.data.saleEndtime;var M=GetParams().id;var N=1;var O;if(A==undefined){O='/member/h5/info'};if(A=="jiheios"){O='/member/client/info';};var P={};$.post(O,{data:JSON.stringify(P)},function(Q){console.log(Q);if(Q.sc=="0"){G=1;l=Q.data.memberGrade;m=Q.data.points;}else if(Q.sc=="-1"){if(A==undefined){var S=window.location.href;location.href="/user/h5/qrcode?regsucc_tourl="+S;return};if(A=="jiheios"){data1='{"act":"toLogin"}';var S="http://www.jihelife.com?data="+data1;iosBridgeObjc(S);$(".payBoxShadow").hide();return}}else{G=0;l=-1};a=1;if(y){for(var S=0;S<y.length;S++){if(y[S].buyerType==l){f=y[S].saleBegintime}}};if(j>0&&j*a>m){};if(a*1>k*1&&k*1!=-1){$(".smallBomb").html("商品库存不足").show();setTimeout(function(){$(".smallBomb").html("").hide()},2000);return};if(a*1>d*1&&b*1!=-1){$(".smallBomb").html("每人最多可购买"+b+"份").show();setTimeout(function(){$(".smallBomb").html("").hide()},2000);return};var R={"userinfo":{"memberInfo":{"memberGrade":l}},"id":M,"amount":N};if(A==undefined){$.post("/product/h5/stock/judge",{data:JSON.stringify(R)},function(S){console.log(S);if(S.sc==0){var T,U=0,V=0;var W=[];if(h>0){U=h*a*100;W.push({'paytype':0,"amount":U})};if(j>0){V=j*a;W.push({'paytype':6,"points":V})};if(U>0){T={'productid':M,'quantity':a,'amount':U,'pointamount':V,'payments':W,'channel':GetParams().mc}}else{T={'productid':M,'quantity':a,'pointamount':V,'payments':W,'channel':GetParams().mc}};var X=JSON.stringify(T);console.log(T);if(undefined!=GetParams().needpoints){window.location.href='/html/order/toOrder.html?id='+T.productid+"&needpoints="+GetParams().needpoints+'&assettype='+assetType+'&couponid='+couponId+'&couponcode='+couponCode}else{window.location.href='/html/order/toOrder.html?id='+T.productid+'&assettype='+assetType+'&couponid='+couponId+'&couponcode='+couponCode}}else if(S.sc=="PRODUCT-1010"){var T=window.location.href;var U=S.ErrorMsg+'<div class="isMember"><p class="memb">该产品仅限几何会员可参与购买</p><a href="/user/h5/qrcode?regsucc_tourl='+T+'">注册加入会员</a></div>';$(".Box2 .confContent").html(U);$(".Box2").show()}else if(S.sc=="PRODUCT-1011"){$(".smallBomb").html(S.ErrorMsg).show();setTimeout(function(){$(".smallBomb").html("").hide()},2000)}else{$(".Box2 .confContent").html(S.ErrorMsg);$(".Box2").show()}})};if(A=="jiheios"){$.post("/product/client/stock/judge",{data:JSON.stringify(R)},function(S){console.log(S);if(S.sc==0){var T;if($(this).hasClass("sure")&&$(this).html()=="确认支付"){T="jf"}else if($("div",this).hasClass("weixin")){T="wx"}else if($("div",this).hasClass("zfbao")){T="alipay"}else if($(this).hasClass("sure")&&$(this).html()=="米庄支付"){T="mz"};$(".Box3").hide();var U,V=0,W=0;var X=[];if(h>0){V=h*a*100;X.push({'paytype':0,"amount":V})};if(j>0){W=j*a;X.push({'paytype':6,"points":W})};if(V>0){U={'productid':M,'quantity':a,'amount':V,'pointamount':W,'payments':X,'channel':GetParams().mc}}else{U={'productid':M,'quantity':a,'pointamount':W,'payments':X,'channel':GetParams().mc}};var Y=JSON.stringify(U);console.log(U);if(undefined!=GetParams().needpoints){window.location.href='/html/order/toOrder.html?id='+U.productid+"&needpoints="+GetParams().needpoints+'&assettype='+assetType+'&couponid='+couponId+'&couponcode='+couponCode}else{window.location.href='/html/order/toOrder.html?id='+U.productid+'&assettype='+assetType+'&couponid='+couponId+'&couponcode='+couponCode}}else if(S.sc=="PRODUCT-1010"){var T=S.ErrorMsg+'<div class="isMember"><p class="memb">该产品仅限几何会员可参与购买</p><a>注册加入会员</a></div>';$(".Box2 .confContent").html(T);$(".Box2").show();$(".Box2 .confContent .isMember a").click(function(){data1='{"act":"toLogin"}';var U="http://www.jihelife.com?data="+data1;iosBridgeObjc(U);$(".payBoxShadow").hide()})}else if(S.sc=="PRODUCT-1011"){$(".smallBomb").html(S.ErrorMsg).show();setTimeout(function(){$(".smallBomb").html("").hide()},2000)}else{$(".Box2 .confContent").html(S.ErrorMsg);$(".Box2").show()}})}})}},error:function(L){console.log(L.status)}})}});