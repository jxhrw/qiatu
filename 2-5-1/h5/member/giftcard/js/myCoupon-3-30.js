function getAllList(e){$.post("/coupon/h5/list",{data:JSON.stringify(e)},function(e){console.log(e),0==e.data.length&&($(".allList").html("<div class='hasNone'>您还没有礼券</div>"),blankPage("hasNone"));for(var a=0;a<e.data.length;a++){var t=e.data[a].couponBaseInfo.couponName,n=parseInt(e.data[a].couponBaseInfo.effectiveTime),s=parseInt(e.data[a].couponBaseInfo.expireTime),o=((new Date).getTime(),'<div class="item"> <h1 class="couponName"><span class="cName">'+t+'</span><span class="suit fr">适用详情</span></h1><ul class="description"> <li class="effective">有效期：<time><span class="effectiveTime">'+getDate(n)+'</span>-<span class="expireTime">'+getDate(s)+'</span></time></li></ul><ul class="couponTrades"><li class="use"><a href="#">订房</a></li> </ul></div>');$(".allList").append(o)}for(var i=0;i<e.data.length;i++){var l=e.data[i].couponBaseInfo.couponType,c=e.data[i].couponBaseInfo.couponName,r=e.data[i].couponBaseInfo.exchangePointsRatio,p=e.data[i].couponCode,d=e.data[i].couponBaseInfo.currencyType,u=e.data[i].couponId,f=e.data[i].couponBaseInfo.businessExchange,m=e.data[i].bookingUrl,h=e.data[i].exchangeUrl,g=e.data[i].goodspurchaseUrl,b=e.data[i].couponBaseInfo.tradable,v=parseInt(e.data[i].couponBaseInfo.exchangePointsDeadline),k=e.data[i].couponBaseInfo.exchangePoints,I=parseInt(e.data[i].faceValue),L=parseInt(e.data[i].freeze),y=parseInt(e.data[i].remain),T=y+freeze(L),q=e.data[i].usageStatus;if(1==b){$(".allList .item").eq(i).find(".use").before('<li><a class=sell href="#">转让</a></li>'),$(".allList .item").eq(i).find(".couponTrades").prepend('<li class="more iconfont icon-dot"><ul class="moreBtns"><li><a class="buy" href="#">购买</a></li></ul></li>');var w="../../market/saleConsumption.html?couponcode="+p+"&currencyType="+d,B="../../order/buyConsumption.html?couponId="+u;$(".allList .item").eq(i).find(".sell").prop("href",w),$(".allList .item").eq(i).find(".buy").prop("href",B),$(".allList .sell").click(function(){sessionStorage.setItem("leave","1")}),$(".allList .buy").click(function(){sessionStorage.setItem("leave","1")})}if($(".allList .item").eq(i).find(".use a").prop("href",m),1==f&&$(".allList .item").eq(i).find(".use").before('<li><a href="'+g+'">换商品</a></li><li><a href="'+h+'">换宿</a></li>'),1==l){var N=e.data[i].couponBaseInfo.applyNights;console.log(N+"晚"),$(".allList .effective").eq(i).after("<li>晚数：&nbsp;&nbsp;<strong>"+N+"晚</strong></li>")}else if(2==l){if(1==k){$(".allList .item").eq(i).find(".moreBtns").append('<li><a class="redeem" href="#">兑换积分</a></li>');var x="./redeem.html?code="+p+"&num="+y/100+"&name="+c+"&ratio="+r+"&PointsDeadline="+v;$(".allList .couponTrades").eq(i).find(".redeem").prop("href",x)}$(".allList .effective").eq(i).after('<li>余额：&nbsp;&nbsp;<span class="remainValue">'+T/100+"</span></li>"),$(".allList .effective").eq(i).next().after('<li>冻结额度：&nbsp;&nbsp;<span class="oFreeze">'+freeze(L)/100+"</span></li>"),$(".allList .effective").eq(i).next().next().after('<li>可用额度：&nbsp;&nbsp;<strong class="oRemainValue">'+y/100+"</strong></li>")}else 5==l||7==l&&$(".allList .effective").eq(i).after("<li>金额：&nbsp;&nbsp;<strong>"+I/100+"</strong></li>");5==q?$(".allList .couponTrades").eq(i).html("<p class='unavailable'>未到使用时间</p>"):4==q?$(".allList .couponTrades").eq(i).html("<p class='unavailable'>已过期</p>"):2==q&&($(".allList .couponTrades").eq(i).html("<p class='unavailable'>已使用</p>"),$(".allList .couponTrades").eq(i).parent().addClass("expired"))}$(".cName").on("click",function(){var a=$(this).index(),t=e.data[a].couponCode;window.location.href="./history.html?code="+t}),$(".allList .more").on("click",function(){$(".getMore").show(),$(".getMore ul").html($(this).find(".moreBtns").html()),$(".mask").show()}),$(".cancelBtn").on("click",function(){$(".getMore").hide(),$(".mask").hide()}),$(".mask").click(function(){$(".getMore").hide(),$(this).hide()}),$(".allList .suit").on("click",function(e){e&&e.stopPropagation?e.stopPropagation():window.event.cancelBubble=!0}),getDetail(),$(".allList .suit").click(function(){var a=$(this).parents(".item").index(),t=e.data[a].couponId;$.post("/coupon/h5/termDetail",{data:JSON.stringify({couponId:t})},function(e){console.log(e);var a=e.data.couponName,t=e.data.couponType;5==t||7==t?$(".couponType span:first-of-type").html("优惠券"):$(".couponType span:first-of-type").html("礼券"),$(".suitDesc>h2").html(a);var n=e.data.productUsable;$.each(n,function(e){$(".productUsable").append('<li class="hotelItem">'+n[e].hotelName+'<br/><span class="useDesc"></span></li>'),n[e].productUsableDesc&&$(".hotelItem").eq(e).find(".useDesc").html(n[e].productUsableDesc)});var s=e.data.dateUsable;s?$.each(s,function(e){$(".dateUsable").show(),$(".dateUsable").append("<li>"+s[e]+"</li>")}):$(".dateUsable").hide();var o=e.data.bookCondition;o?$.each(o,function(e){$(".bookCondition").show(),$(".bookCondition").append("<li>"+o[e]+"</li>")}):$(".bookCondition").hide();var i=e.data.remark;i?($(".remark").show(),$(".remark").append("<li>"+i+"</li>")):$(".remark").hide();var l=e.data.agreementInfo;l&&$(".remark").after('<ul class="agreementInfo"><a style="color: #336dc1" href="'+l.h5Url+'">'+l.name+"</a></ul>")})})})}function getTradableList(){$.post("/coupon/h5/list",{data:JSON.stringify({pageno:1,pagecnt:50,tradable:1})},function(e){console.log(e),0==e.data.length&&($(".transList").html("<div class='hasNone'>您还没有礼券</div>"),blankPage("hasNone"));for(var a=0;a<e.data.length;a++){var t=e.data[a].couponBaseInfo.couponName,n=parseInt(e.data[a].couponBaseInfo.effectiveTime),s=parseInt(e.data[a].couponBaseInfo.expireTime),o=((new Date).getTime(),'<div class="item"> <h1 class="couponName"><span class="cName">'+t+'</span><span class="suit fr">适用详情</span></h1><ul class="description"> <li class="effective">有效期：<time><span class="effectiveTime">'+getDate(n)+'</span>-<span class="expireTime">'+getDate(s)+'</span></time></li></ul><ul class="couponTrades"><li class="use"><a href="#">订房</a></li> </ul></div>');$(".transList").append(o)}for(var i=0;i<e.data.length;i++){var l=e.data[i].couponBaseInfo.couponType,c=e.data[i].couponBaseInfo.couponName,r=e.data[i].couponBaseInfo.exchangePointsRatio,p=e.data[i].couponCode,d=e.data[i].couponBaseInfo.currencyType,u=e.data[i].couponId,f=e.data[i].couponBaseInfo.businessExchange,m=e.data[i].bookingUrl,h=e.data[i].exchangeUrl,g=e.data[i].goodspurchaseUrl,b=e.data[i].couponBaseInfo.tradable,v=parseInt(e.data[i].couponBaseInfo.exchangePointsDeadline),k=e.data[i].couponBaseInfo.exchangePoints,I=parseInt(e.data[i].faceValue),L=parseInt(e.data[i].freeze),y=parseInt(e.data[i].remain),T=y+freeze(L),q=e.data[i].usageStatus;if(1==b){$(".transList .item").eq(i).find(".use").before('<li><a class=sell href="#">转让</a></li>'),$(".transList .item").eq(i).find(".couponTrades").prepend('<li class="more iconfont icon-dot"><ul class="moreBtns"><li><a class="buy" href="#">购买</a></li></ul></li>');var w="../../market/saleConsumption.html?couponcode="+p+"&currencyType="+d,B="../../order/buyConsumption.html?couponId="+u;$(".transList .item").eq(i).find(".sell").prop("href",w),$(".transList .item").eq(i).find(".buy").prop("href",B),$(".transList .sell").click(function(){sessionStorage.setItem("leave","1")}),$(".transList .buy").click(function(){sessionStorage.setItem("leave","1")})}if(console.log(f),$(".transList .item").eq(i).find(".use a").prop("href",m),1==f&&$(".transList .item").eq(i).find(".use").before('<li><a href="'+g+'">换商品</a></li><li><a href="'+h+'">换宿</a></li>'),1==l){var N=e.data[i].couponBaseInfo.applyNights;console.log(N+"晚"),$(".transList .effective").eq(i).after("<li>晚数：&nbsp;&nbsp;<strong>"+N+"晚</strong></li>")}else if(2==l){if(1==k){$(".transList .item").eq(i).find(".moreBtns").append('<li><a class="redeem" href="#">兑换积分</a></li>');var x="./redeem.html?code="+p+"&num="+y/100+"&name="+c+"&ratio="+r+"&PointsDeadline="+v;$(".transList .couponTrades").eq(i).find(".redeem").prop("href",x)}$(".transList .effective").eq(i).after('<li>余额：&nbsp;&nbsp;<span class="remainValue">'+T/100+"</span></li>"),$(".transList .effective").eq(i).next().after('<li>冻结额度：&nbsp;&nbsp;<span class="oFreeze">'+freeze(L)/100+"</span></li>"),$(".transList .effective").eq(i).next().next().after('<li>可用额度：&nbsp;&nbsp;<strong class="oRemainValue">'+y/100+"</strong></li>")}else 5==l||7==l&&$(".transList .effective").eq(i).after("<li>金额：&nbsp;&nbsp;<strong>"+I/100+"</strong></li>");5==q?$(".transList .couponTrades").eq(i).html("<p class='unavailable'>未到使用时间</p>"):4==q?$(".transList .couponTrades").eq(i).html("<p class='unavailable'>已过期</p>"):2==q&&($(".transList .couponTrades").eq(i).html("<p class='unavailable'>已使用</p>"),$(".transList .couponTrades").eq(i).parent().addClass("expired"))}$(".cName").on("click",function(){var a=$(this).index(),t=e.data[a].couponCode;window.location.href="./history.html?code="+t}),$(".transList .more").on("click",function(){$(".getMore").show(),$(".getMore ul").html($(this).find(".moreBtns").html()),$(".mask").show()}),$(".cancelBtn").on("click",function(){$(".getMore").hide(),$(".mask").hide()}),$(".mask").click(function(){$(".getMore").hide(),$(this).hide()}),$(".transList .suit").on("click",function(e){e&&e.stopPropagation?e.stopPropagation():window.event.cancelBubble=!0}),getDetail(),$(".transList .suit").click(function(){var a=$(this).parents(".item").index(),t=e.data[a].couponId;$.post("/coupon/h5/termDetail",{data:JSON.stringify({couponId:t})},function(e){console.log(e);var a=e.data.couponName,t=e.data.couponType;5==t||7==t?$(".couponType span:first-of-type").html("优惠券"):$(".couponType span:first-of-type").html("礼券"),$(".suitDesc>h2").html(a);var n=e.data.productUsable;$.each(n,function(e){$(".productUsable").append('<li class="hotelItem">'+n[e].hotelName+'<br/><span class="useDesc"></span></li>'),n[e].productUsableDesc&&$(".hotelItem").eq(e).find(".useDesc").html(n[e].productUsableDesc)});var s=e.data.dateUsable;s?$.each(s,function(e){$(".dateUsable").show(),$(".dateUsable").append("<li>"+s[e]+"</li>")}):$(".dateUsable").hide();var o=e.data.bookCondition;o?$.each(o,function(e){$(".bookCondition").show(),$(".bookCondition").append("<li>"+o[e]+"</li>")}):$(".bookCondition").hide();var i=e.data.remark;i?($(".remark").show(),$(".remark").append("<li>"+i+"</li>")):$(".remark").hide();var l=e.data.agreementInfo;l&&$(".remark").after('<ul class="agreementInfo"><a style="color: #336dc1" href="'+l.h5Url+'">'+l.name+"</a></ul>")})})})}function getRecList(e,a){$.post("/trade/h5/selling/record",{data:JSON.stringify({pageno:e,pagecnt:a})},function(e){console.log(e),$.each(e.data,function(a){var t=e.data[a].couponName,n=parseInt(e.data[a].expiredTime),s=parseInt(e.data[a].availableAmount),o=parseInt(e.data[a].sellAmount),i=parseInt(e.data[a].lockAmount),l=s+o+i,c=parseInt(e.data[a].price),r=e.data[a].priceType,p=e.data[a].pointsPrice,d=parseInt(e.data[a].sellPrice),u=parseInt(e.data[a].serviceCharge),f=e.data[a].status,m=e.data[a].sellingId,h='<div class="item"> <h1 class="couponName">'+t+'</h1><ul class="description"> <li>转让额度:<span>'+l/100+"</span></li><li>转让总价:&nbsp;<span>"+function(e){return 0==e?"&yen"+c/100:1==e?p+"积分":void 0}(r)+"</span></li><li >已成交:&nbsp;&nbsp;<span>"+o/100+"</span></li><li>成交总价:&nbsp;<span>"+priceType(r,d)+"</span></li><li>交易服务费:<span>"+priceType(r,u)+'</span></li> <li class="effective">转让截止时间：&nbsp;<time><span class="expireTime">'+expire(n)+'</span></time></li></ul><ul id="'+m+'" class="couponTrades"></ul></div>';$(".recList>div").append(h),$("#"+m).append(tradeStatus(f)),0==f&&($("#"+m+" .waiting").after('<li class="cancel"><a href="javascript:;">取消交易</a></li>'),$("#"+m+" .cancel").on("click",function(){$(".popCancel").show(),$(".popCancel span").html($(this).parent(".couponTrades").siblings(".couponName").html()),$(".mask").show();var e=$(this).parent().attr("id");console.log(e),$(".yes").attr("id","num"+e)}))}),e.data.length<4&&e.data.length>=0&&$(".load").html("已经加载完"),0==$(".recList .item").length&&($(".recList").html("<div class='hasNone'>您还没有转让记录</div>"),blankPage("hasNone"))})}function getDate(e){var a=new Date(e);return y=a.getFullYear(),m=a.getMonth()+1,d=a.getDate(),y+"/"+(m<10?"0"+m:m)+"/"+(d<10?"0"+d:d)}function getDetail(){$(".suit").click(function(){$(".mask").fadeIn(),$(".popup").animate({bottom:"0"})}),$(".know").click(function(){$(".mask").fadeOut(),$(".popup").animate({bottom:"-22rem"}),$(".productUsable").html('<li class="proTitle">可用商户及房型</li>'),$(".dateUsable").html(""),$(".bookCondition").html(""),$(".remark").html(""),$(".agreementInfo").html("")}),$(".close").click(function(){$(".mask").fadeOut(),$(".popup").animate({bottom:"-22rem"}),$(".productUsable").html('<li class="proTitle">可用商户及房型</li>'),$(".dateUsable").html(""),$(".bookCondition").html(""),$(".remark").html(""),$(".agreementInfo").html("")}),$(".mask").click(function(){$(this).fadeOut(),$(".popup").animate({bottom:"-22rem"}),$(".productUsable").html('<li class="proTitle">可用商户及房型</li>'),$(".dateUsable").html(""),$(".bookCondition").html(""),$(".remark").html(""),$(".agreementInfo").html("")})}function expire(e){return e?getDate(e):"<span class='soldOut'>卖完为止</span>"}function freeze(e){return e?parseInt(e):0}function priceType(e,a){return 0==e?"&yen"+a/100:1==e?a+"积分":void 0}function tradeStatus(e){return 0==e?"<p class='waiting'>交易中</p>":4==e?"<p class='ok'>已取消</p>":5==e?"<p class='ok'>交易完成</p>":void 0}function blankPage(e){$("."+e).css({"text-align":"center","margin-top":"40%",background:'url("http://7xio74.com1.z0.glb.clouddn.com/blankPage.png") no-repeat center top/40%',"padding-top":"13rem"})}$(function(){1==sessionStorage.getItem("leave")&&(sessionStorage.setItem("leave","0"),window.location.reload());var e=$(".header").height(),a=window.innerHeight-e,t=window.innerWidth;$(".couponList").css({height:a,width:t}),getAllList({pageno:1,pagecnt:50}),getTradableList(),getRecList(1,4),$(".yes").on("click",function(){console.log($(this).attr("id"));var e=$(this).attr("id").match(/\d/g).join("");console.log(e),$.post("/trade/h5/selling/cancel",{data:JSON.stringify({sellingid:e})},function(a){if(console.log(a),0==a.sc){$(".popCancel").hide(),$(".popSuccess").show(),$(".popSuccess p").html("取消成功，冻结的资金或消费金将在2个小时内返还到您的几何会员账户");var t;$.post("/trade/h5/selling/record",{data:JSON.stringify({pageno:1,pagecnt:10})},function(a){console.log(a);var n=$("#"+e).parent(".item").index();$("#"+e).html(tradeStatus(a.data[0].status)),t=a.data[n].couponId}),$.post("/pay/h5/coupon/list",{data:JSON.stringify({pageno:1,pagecnt:50})},function(e){$.each(e.data,function(a){var t=parseInt(e.data[a].freeze),n=parseInt(e.data[a].remain),s=n+freeze(t);$(".allList .item").eq(a).find(".oRemainValue").html(n/100),$(".allList .item").eq(a).find(".oFreeze").html(freeze(t)/100),$(".allList .item").eq(a).find(".remainValue").html(s/100)})}),$.post("/pay/h5/coupon/list",{data:JSON.stringify({pageno:1,pagecnt:50,tradable:1})},function(e){console.log(e),$.each(e.data,function(a){var t=freeze(e.data[a].freeze),n=parseInt(e.data[a].remain),s=n+freeze(t);$(".transList .item").eq(a).find(".tRemain").html(s/100),$(".transList .item").eq(a).find(".tFreeze").html(freeze(t)/100),$(".transList .item").eq(a).find(".tSell").html(n/100)})})}else"TRADE-1002"==a.sc?($(".popCancel").hide(),$(".popSuccess").show(),$(".popSuccess p").html("有人正在购买你的消费金，暂无法取消交易，请稍后尝试")):($(".popCancel").hide(),$(".popSuccess").show(),$(".popSuccess p").html("对不起，此次取消失败，请稍后尝试"))})}),$(".sucYes").on("click",function(){$(".popSuccess").hide(),$(".mask").hide()}),$(".wrong").on("click",function(){$(".popCancel").hide(),$(".mask").hide()}),$(".mask").on("click",function(){$(this).hide(),$(".popCancel").hide(),$(".popSuccess").hide()});var n=1;$(".recList").scroll(function(){var e=$(this).scrollTop(),t=$(this)[0].scrollHeight;"已经加载完"!=$(".load").html()&&e+a+3>=t&&(n++,getRecList(n,4))})});