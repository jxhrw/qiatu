var orderUrl="/order/h5/info",orderData={orderid:GetParams().orderid},referrer=document.referrer,paychannel,priceType,productid,ua=window.navigator.userAgent.toLowerCase(),objectType,cashBalance,jsTime=0,once=0,showCyType;$(document).ready(function(){function e(e,a,t){var i=window.location.href.split("/html")[0]+"/html/h5/order/orderDetailN.html?orderid="+e,s={orderid:e,paychannel:t};"jf"==t&&delete s.paychannel;"mz"!=t&&"alipay_wap"!=t||(s.successurl=i,s.cancelurl=i),$.post(h5orClient("/order/h5/pay"),{data:JSON.stringify(s)},function(s){if(0==s.sc)if(null!=s.data.payTicketInfo)if("jh"==s.data.payTicketInfo.channel){var o={chargeId:s.data.payTicketInfo.chargeId,tradeToken:a};$.post(h5orClient("/pay/h5/balance/confirmCharge"),{data:JSON.stringify(o)},function(e){if(console.log(e),-1!=referrer.indexOf("Detail"))sessionStorage.setItem("paymentLeave",1),window.history.go(-1);else{if("micromessenger"!=ua.match(/MicroMessenger/i)&&/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&/jihe/i.test(navigator.userAgent)){iosBridgeObjc('http://www.jihelife.com?data={"backPage":"2"}')}sessionStorage.setItem("paymentLeave",1),window.location.href=i}$("#immPay").removeClass("no")})}else if("mz"==s.data.payTicketInfo.channel)sessionStorage.setItem("paymentLeave",1),window.location.href=s.data.payTicketInfo.redirectUrl;else if("micromessenger"!=ua.match(/MicroMessenger/i)&&/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&/jihe/i.test(navigator.userAgent)){if(-1!=referrer.indexOf("Detail")){var r='{"orderid":"'+e+'","paychannel":"'+t+'","act":"toPay","orderUrl":"-1","backPage":"2"}',n="http://www.jihelife.com?data="+r;iosBridgeObjc(n),console.log(n),sessionStorage.setItem("paymentLeave",1)}else{var d=i,l='{"orderid":"'+e+'","paychannel":"'+t+'","act":"toPay","orderUrl":"'+encodeURIComponent(d)+'","backPage":"2"}',c="http://www.jihelife.com?data="+l;iosBridgeObjc(c),console.log(c),sessionStorage.setItem("paymentLeave",1)}$("#immPay").removeClass("no")}else pingpp.createPayment(s.data.payTicketInfo,function(a,t){console.log(a),"cancel"==a?$.post("/order/h5/breakpay/"+e,function(e){console.log(e),0==e.sc&&(-1!=referrer.indexOf("Detail")?(sessionStorage.setItem("paymentLeave",1),window.history.go(-1)):(sessionStorage.setItem("paymentLeave",1),window.location.href=i))}):"success"==a&&(-1!=referrer.indexOf("Detail")?(sessionStorage.setItem("paymentLeave",1),window.history.go(-1)):(sessionStorage.setItem("paymentLeave",1),window.location.href=i))}),$("#immPay").removeClass("no");else-1!=referrer.indexOf("Detail")?(sessionStorage.setItem("paymentLeave",1),window.history.go(-1)):(sessionStorage.setItem("paymentLeave",1),window.location.href=i);else"BASE-1002"==s.sc?(errorPrompt(chinese("请选择支付方式"),2e3),$("#immPay").removeClass("no")):(errorPrompt(chinese(s.ErrorMsg),2e3),$("#immPay").removeClass("no"))})}function a(e,a){$("#setButton,.checkForget").click(function(){$("#digital").remove(),$(".checkPsword").hide(),$(".popupT,.setPsword").hide(),l(),$("#owner").html(a),$("#phoneNum").html(e.substr(0,3)+"****"+e.substr(7,4)),$(".popupT,.textPs").show(),"setButton"==$(this).attr("id")?goHttp=0:goHttp=1})}function t(){$("#sure").click(function(){var e=$(".SMSVer input").val(),a={verifycode:e};$.post(h5orClient("/user/h5/checkverifycode"),{data:JSON.stringify(a)},function(a){console.log(a);var t;0==goHttp?t=1:1==goHttp&&(t=2),"0"==a.sc?(sessionStorage.setItem("paymentLeave",2),window.location.href="/html/h5/member/personinfo/password.html?type="+t+"&verifycode="+e):errorPrompt(chinese("验证码错误"),2e3)})})}function i(e){return minutes=parseInt(e/60),seconds=parseInt(e%60),formatNum(minutes)+":"+formatNum(seconds)}function s(e){$(e).find("td").css({"border-color":"#9b9b9b"});for(var a=0;a<$(e).find("td").length;a++){if(""==$(e).find("td").eq(a).html())return void $(e).find("td").eq(a).css({"border-color":"#000"});$(e).find("td").eq(a).css({"border-color":"#000"})}}function o(e,a,t,i,o,n){$(a).html('<table id="digital" cellpadding="0" cellspacing="0" width="100%"><tr><td>1</td><td>2</td><td>3</td></tr><tr><td>4</td><td>5</td><td>6</td></tr><tr><td>7</td><td>8</td><td>9</td></tr><tr><td style="background-color: #d2d5db;"></td><td>0</td><td id="delete"><em></em></td></tr></table>'),$("#delete").css({background:"#d2d5db"}).find("em").css({background:"url(/html/member/images/delete.jpg) no-repeat center/contain",display:"inline-block",width:"1.53rem",height:"1.13rem"}),$("#digital").css({"text-align":"center","font-size":"1.4rem","table-layout":"fixed"}).find("td").css({"border-right":"1px solid #8c8c8c","border-bottom":"1px solid #8c8c8c",padding:"1rem 0",cursor:"pointer","-moz-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","-khtml-user-select":"none","user-select":"none"}),$("#digital tr td:last-child").css({"border-right":"0"}),$("#digital tr:last-child td").css({"border-bottom":"0"}),$("#digital td").on("touchstart",function(){if("delete"!=$(this).attr("id"))r(this,e,t,i,o,n);else if("table"==i){$(n).addClass("no");for(var a=$(e).find("td").length-1;a>=0;a--)if($(e).find("td").eq(a).html())return $(e).find("td").eq(a).html("").removeAttr("value"),void s("#inputPassword")}else{var d=$(e).html(),l=$(e).attr("value")?$(e).attr("value"):"";d.length<=1?$(e).html("").removeAttr("value"):(d=d.substr(0,d.length-1),l=l.substr(0,l.length-1),$(e).html(d).attr("value",l))}s("#inputPassword")})}function r(e,a,t,i,s,o){var r=$(e).html(),n="<div class='star'>*</div>";if(""!=r)if("table"==i){for(var l=0;l<$(a).find("td").length&&l<t;l++)if(!$(a).find("td").eq(l).html())return"password"==s?$(a).find("td").eq(l).html(n).attr("value",r):$(a).find("td").eq(l).html(r),void(l==t-1&&d(o))}else{var c=$(a).html(),m=$(a).attr("value")?$(a).attr("value"):"";(c.length<t||void 0==t)&&("password"==s?$(a).html(c+n).attr("value",m+r):$(a).html(c+r),(c+r).length==t&&d(o))}}function n(e,a,t){var i="";return"table"==a?"password"==t?$(e).find("td").each(function(){i+=$(this).attr("value")?$(this).attr("value"):""}):$(e).find("td").each(function(){i+=$(this).html()}):i="password"==t?$(e).attr("value")?$(e).attr("value"):"":$(e).html(),i}function d(e){$(e).removeClass("no")}function l(){if(0==jsTime){var e={verifycodetype:2};$("#again").addClass("no");$.post(h5orClient("/user/h5/getverifycode"),{data:JSON.stringify(e)},function(e){console.log(e)}),jsTime=60;var a=setInterval(function(){jsTime--,$("#again").html(jsTime+"S"),0==jsTime&&($("#again").html("重新发送").removeClass("no"),clearInterval(a))},1e3)}}if($(".popupT").height($(window).height()),1==sessionStorage.getItem("paymentLeave")&&(sessionStorage.setItem("paymentLeave",0),window.history.back()),2==sessionStorage.getItem("paymentLeave")){var c=sessionStorage.getItem("tradeToken");sessionStorage.setItem("tradeToken",""),sessionStorage.setItem("paymentLeave",0),e(GetParams().orderid,c,"jh")}$.post(h5orClient(orderUrl),{data:JSON.stringify(orderData)},function(e){if(0==e.sc){objectType=e.data.objectType;var a=0,t=0,s=0,o=0,r=0,n=parseInt(e.data.countDown?e.data.countDown:0),d=parseInt(e.data.checkin),l=parseInt(e.data.checkout),c=parseInt((l-d)/24/3600/1e3),m=e.data.payments;showCyType=e.data.showCyType,showCyCode=e.data.showCyCode?e.data.showCyCode:"",showCyUnit=e.data.showCyUnit?e.data.showCyUnit:"",showCyAmount=e.data.showCyAmount?e.data.showCyAmount:0,"0"!=showCyType&&"5"!=showCyType||(showCyAmount=e.data.showCyAmount/100);var p='<div class="clearfix multiLine2"><div class="function gray fl">总价：</div><div class="quota fr">'+showCyCode+showCyAmount+showCyUnit+"</div></div>";if("31"==objectType||"30"==objectType||"40"==objectType){if($("#virOrderDetail").hide(),$("#virtualProName,#payInfo,#tipsAndPhone").show(),$("#virProName").html(e.data.ordername),$("#virCustomerName").html(e.data.customerName),$("#virCustomerMobile").html(e.data.customerMobile),$("#virProNumber").html(e.data.quantity),$("#virComments").html(e.data.comments),void 0!=e.data.customerAddress){var h=e.data.customerAddress;h=h.split(","),$("#virCustomerName").html(h[0]),$("#virCustomerMobile").html(h[1]),$("#virProAddress").html(h[2])}}else $("#roomProName,#payInfo,#tipsAndPhone,.bookingTips").show(),$(".bookingTips").html(e.data.cancelPolicy),$("#roomName").html(e.data.ordername),$("#checkIn").html(newFormatStrDateNoYear(new Date(d),"/")),$("#checkOut").html(newFormatStrDateNoYear(new Date(l),"/")),$("#nights").html(c),$("#customerName").html(e.data.customerName),$("#customerMobile").html(e.data.customerMobile),$("#comments").html(e.data.comments),$("#countDown").html(i(n));if(n>0)var u=setInterval(function(){n--,$("#countDown").html(i(n)),0==n&&($("#immPay").addClass("no").addClass("noClick"),$(".timeIcon,#countDown").hide(),clearInterval(u))},1e3);else $("#immPay").addClass("no").addClass("noClick"),$(".timeIcon,#countDown").hide();for(var y=0;void 0!=m&&y<m.length;y++)if(0==m[y].payType)a+=parseInt(m[y].amount);else if(1==m[y].payType||2==m[y].payType)t+=parseInt(m[y].amount);else if(3==m[y].payType)s+=parseInt(m[y].amount);else if(4==m[y].payType)o+=parseInt(m[y].amount);else if(5==m[y].payType||7==m[y].payType)r+=parseInt(m[y].amount);else if(6==m[y].payType)p+='<div class="clearfix multiLine2"><div class="function gray fl">积分：</div><div class="quota fr">'+m[y].faceValue+"个</div></div>";else if(11==m[y].payType){var f=m[y].faceValue;void 0==f&&(f=1),p+='<div class="clearfix multiLine2"><div class="function gray fl">礼券：</div><div class="quota fr">'+m[y].couponAlias+f+"张</div></div>"}else 12==m[y].payType&&(p+='<div class="clearfix multiLine2"><div class="function gray fl">礼券：</div><div class="quota fr">'+m[y].couponAlias+m[y].faceValue/100+"元</div></div>");t>0&&(p+='<div class="clearfix multiLine2"><div class="function gray fl">礼券：</div><div class="quota fr">-￥'+t/100+"</div></div>"),r>0&&(p+='<div class="clearfix multiLine2"><div class="function gray fl">优惠券：</div><div class="quota fr">-￥'+r/100+"</div></div>"),s>0&&(p+='<div class="clearfix multiLine2"><div class="function gray fl">积分兑房：</div><div class="quota fr">-￥'+s/100+"</div></div>"),o>0&&(p+='<div class="clearfix multiLine2"><div class="function gray fl">积分抵现：</div><div class="quota fr">-￥'+o/100+"</div></div>"),a>0?($("#shouldPay").html("￥"+a/100),p+='<div class="clearfix multiLine2"><div class="function gray fl">应付：</div><div class="quota paleRed fr">￥'+a/100+"</div></div>"):0==a&&$("#shouldPay").html("￥"+a/100),void 0!=e.data.payments&&1==e.data.payments.length&&6==e.data.payments[0].payType&&(p='<div class="clearfix multiLine2"><div class="function gray fl">总价：</div><div class="quota fr">'+e.data.payments[0].points+'积分</div></div><div class="clearfix multiLine2"><div class="function gray fl">应付：</div><div class="quota paleRed fr">'+e.data.payments[0].points+"积分</div></div>"),$("#payInfoDiv").html(p),productid={id:e.data.productid};$.post(h5orClient("/product/h5/query"),{data:JSON.stringify(productid)},function(t){if(0==t.sc){priceType=t.data.productPrice.priceType;var i=t.data.payChannelList,s="",o={};$.post(h5orClient("/member/h5/info"),{data:JSON.stringify(o)},function(t){if(0==t.sc)if(a>0){cashBalance=parseInt(t.data.cashBalance?t.data.cashBalance:0);for(var o=0;void 0!=i&&o<i.length;o++)if(/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&/jihe/i.test(navigator.userAgent)?("alipay"==i[o]&&(s+='<li id="alipay"><img class="alipay" src="images/alipay.png" alt="">支付宝支付<span class="choice2 fr"></span></li>'),"wx"==i[o]&&(s+='<li id="wx"><img class="wxpay" src="images/wxpay.png" alt="">微信支付<span class="choice2 fr"></span></li>')):"micromessenger"==ua.match(/MicroMessenger/i)?"wx_pub2"==i[o]?s+='<li id="wx_pub2"><img class="wxpay" src="images/wxpay.png" alt="">微信支付<span class="choice2 fr"></span></li>':"wx_pub"==i[o]&&(s+='<li id="wx_pub"><img class="wxpay" src="images/wxpay.png" alt="">微信支付<span class="choice2 fr"></span></li>'):"alipay_wap"==i[o]&&(s+='<li id="alipay_wap"><img class="alipay" src="images/alipay.png" alt="">支付宝支付<span class="choice2 fr"></span></li>'),"jh"==i[o]&&(s+=cashBalance>=a?'<li id="jh"><img class="jhpay" src="images/jhpay.png" alt="">账户余额支付(<span id="remain">￥'+cashBalance/100+'</span>)<span class="choice2 fr"></span></li>':'<li id="jh" class="no" style="color: #999;"><img class="jhpay" src="images/jhpaygrey.png" alt="">账户余额支付(<span id="remain">￥'+cashBalance/100+'</span>)<span class="choice2 fr"></span></li>'),"mz"==i[o]){s="",paychannel="mz",$("#immPay .payWord").html("米庄支付");break}if(""!=s){$("#payMethod").show(),$("#payChannelUl").html(s);var r=$("#payChannelUl li");1==r.length&&(r.find(".choice2").addClass("choosed"),paychannel=r.attr("id")),r.on("touchstart",function(){$(".choice2",this).hasClass("choosed")?($(".choice2",this).removeClass("choosed"),paychannel=""):($(".payChannelList li .choice2").removeClass("choosed"),$(".choice2",this).addClass("choosed"),paychannel=$(this).attr("id"))})}}else{for(var o=0;void 0!=i&&o<i.length;o++)/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&/jihe/i.test(navigator.userAgent)?paychannel="wx":"micromessenger"==ua.match(/MicroMessenger/i)?"wx_pub2"==i[o]?paychannel="wx_pub2":"wx_pub"==i[o]&&(paychannel="wx_pub"):paychannel="alipay_wap";void 0==e.data.payments||1!=e.data.payments.length||6!=e.data.payments[0].payType&&11!=e.data.payments[0].payType&&12!=e.data.payments[0].payType||(paychannel="jf")}else errorPrompt(chinese(t.ErrorMsg),2e3)})}else errorPrompt(chinese(t.ErrorMsg),2e3)})}else errorPrompt(chinese(e.ErrorMsg),2e3)}),$("#immPay").click(function(){if($("#immPay").addClass("no"),"jh"==paychannel){var i,r,n={};$.post(h5orClient("/user/h5/existtradepasswd"),{data:JSON.stringify(n)},function(e){0==e.sc?(i=e.data.mobileAccount,r=e.data.realName,"1"==e.data.existTradePasswd&&($(".popupT,.checkPsword").show(),s("#inputPassword"),o("#inputPassword",".keyboard","6","table","password",".button"),0==once&&(a(i,r),t(),once++)),"0"==e.data.existTradePasswd&&($(".popupT,.setPsword").show(),0==once&&(a(i,r),t(),once++))):errorPrompt(chinese(e.ErrorMsg),2e3),$("#immPay").removeClass("no")})}else void 0!=paychannel&&""!=paychannel?e(GetParams().orderid,"",paychannel):(errorPrompt(chinese("请选择支付方式"),2e3),$("#immPay").removeClass("no"))}),$("#checkBtn").click(function(){$("#checkBtn").addClass("no");var a={tradepasswd:n("#inputPassword","table","password")};$.post(h5orClient("/user/h5/checktradepasswd"),{data:JSON.stringify(a)},function(a){console.log(a),0==a.sc?e(GetParams().orderid,a.data.tradeToken,paychannel):($(".checkTitle p").html("密码错误"),$("#inputPassword").find("td").css({"border-color":"#9b9b9b"}).html("").removeAttr("value"))})}),$("#again").click(function(){l()}),$("#checkClose,.backShadow").click(function(){$(".popupT,.setPsword,.checkPsword,.textPs").hide(),$(".checkTitle p").html("&nbsp;"),$("#inputPassword").find("td").css({"border-color":"#9b9b9b"}).html("").removeAttr("value")}),$("#lookVirOrderDetail").click(function(){$("#virOrderDetail").show()})});