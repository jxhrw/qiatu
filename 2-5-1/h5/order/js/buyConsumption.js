$(document).ready(function(){function t(t){$(".footRight").addClass("no"),clearTimeout(g),g=setTimeout(function(){""!=$("#buyMoney").val()&&0!=Math.round(100*$("#buyMoney").val())||$("#enjoyDiscount").hide();var o={couponId:l,amount:Math.round(100*$("#buyMoney").val()),priceType:d};void 0!=c&&"point"!=c||$(".perWord").html("兑换比例"),"cash"==c&&$(".perWord").html("可享折扣"),$("#buyMoney").val()>0?$.post(h5orClient("/trade/h5/buying/computeprice"),{data:JSON.stringify(o)},function(o){if(0==o.sc){if(Math.round(100*$("#buyMoney").val())>o.data.amount&&($("#prompt").html("消费金可购额度不足").show(),setTimeout(function(){$("#prompt").html("").hide()},2e3),$("#buyMoney").val(Math.round(o.data.amount/100))),0==o.data.amount)return void $("#enjoyDiscount").hide();""!=$("#buyMoney").val()&&Math.round(100*$("#buyMoney").val())>0&&"cash"==c?$("#enjoyDiscount").show():$("#enjoyDiscount").hide();var e=o.data.discount,a=o.data.exchangeRate;o.data.pointsPrice;void 0!=c&&"point"!=c||($("#shouldPrice").html(o.data.pointsPrice),void 0!=a&&$("#pert").html("1:"+Math.ceil(a)/10)),"cash"==c&&($("#shouldPrice").html(floatFixed2(o.data.price/100)),void 0!=e&&$("#pert").html(Math.ceil(e)+"%"))}else $("#buyMoney").val(t),$("#prompt").html("请稍后再试").show(),setTimeout(function(){$("#prompt").html("").hide()},2e3);h=$("#buyMoney").val(),$(".footRight").removeClass("no")}):$("#shouldPrice").html("0"),clearTimeout(g)},1e3)}function o(o,e,a,i){var n=o.val(),d=n.replace(/[^0-9]/g,"");""==d?((void 0==e||e.length<=1)&&(e=""),""==n&&(e=""),o.val(e)):(parseInt(d)>i&&(d=i),parseInt(d)<a&&(d=a),o.val(d)),t(e)}function e(t){var o={couponid:t,type:"1",priceType:d};void 0!=c&&"point"!=c||(o.type=0,$(".selling th").eq(2).html("转让单价(积分)"),$(".selling th").eq(3).html("售价(积分)")),"cash"==c&&(o.type=1),$.post(h5orClient("/trade/h5/selling/onsale"),{data:JSON.stringify(o)},function(t){if("0"==t.sc){var o="";if(t.data.length<=0)o+='<tr><td colspan="4" style="border-bottom: none;">暂无卖单</td></tr>';else for(var e=0;void 0!=t.data&&e<t.data.length;e++){var a,i;void 0!=c&&"point"!=c||(a=(t.data[e].exchangeRate/10).toFixed(1),i=t.data[e].pointsPrice),"cash"==c&&(a=t.data[e].discount+"%",i=t.data[e].price/100),o+="<tr><td>"+(e+1)+"</td><td>"+t.data[e].availableAmount/100+"</td><td>"+a+"</td><td>"+i+"</td></tr>"}$("#selling").html(o)}else $("#prompt").html("请稍后再试").show(),setTimeout(function(){$("#prompt").html("").hide()},2e3)})}function a(){var t={couponid:l};$.post(h5orClient("/trade/h5/buying/product"),{data:JSON.stringify(t)},function(t){if(console.log(t),0==t.sc){if(r=t.data.buyingId,void 0==t.data.productBaseInfo)return;$(".backShadow").addClass("no"),$("#productName").html(t.data.productBaseInfo.productName),$("#productAmount").html(t.data.productBaseInfo.referPrice),void 0!=c&&"point"!=c||$("#productPrice").html(t.data.productBaseInfo.productPrice.totalPointPrice+"积分"),"cash"==c&&$("#productPrice").html("￥"+floatFixed2(t.data.productBaseInfo.productPrice.totalPrice/100)),$(".popupT,#isProduct").show(),void 0==t.data.orderBaseInfo?($("#orderAgain").click(function(){$("#orderAgain").addClass("no");var o={buyingId:t.data.buyingId};$.post(h5orClient("/trade/h5/buying/cancel"),{data:JSON.stringify(o)},function(t){console.log(t),0==t.sc&&($(".popupT,#isProduct").hide(),$(".backShadow").removeClass("no"),e(l)),$("#orderAgain").removeClass("no")})}),$("#toPay").click(function(){sessionStorage.setItem("isGoBack",JSON.stringify(1)),void 0!=c&&"point"!=c||(window.location.href="/html/h5/order/payChannels.html?payMethod=point&data="+t.data.productBaseInfo.productId+"&buyingId="+r),"cash"==c&&(window.location.href="/html/h5/order/payChannels.html?data="+t.data.productBaseInfo.productId+"&buyingId="+r)})):($("#orderAgain").click(function(){$("#orderAgain").addClass("no");var o={orderid:t.data.orderBaseInfo.orderid};$.post(h5orClient("/order/h5/cancel"),{data:JSON.stringify(o)},function(t){console.log(t),0==t.sc&&($(".popupT,#isProduct").hide(),$(".backShadow").removeClass("no"),e(l)),$("#orderAgain").removeClass("no")})}),$("#toPay").click(function(){sessionStorage.setItem("isGoBack",JSON.stringify(1)),void 0!=c&&"point"!=c||(window.location.href="/html/h5/order/payChannels.html?payMethod=point&data="+t.data.productBaseInfo.productId+"&orderid="+t.data.orderBaseInfo.orderid+"&buyingId="+r),"cash"==c&&(window.location.href="/html/h5/order/payChannels.html?data="+t.data.productBaseInfo.productId+"&orderid="+t.data.orderBaseInfo.orderid+"&buyingId="+r)}))}})}function i(t){var o;o=document.createElement("iframe"),o.setAttribute("src",t),o.setAttribute("style","display:none;"),document.body.appendChild(o),o.parentNode.removeChild(o)}var n,d,r,s=$(window).height(),l=GetParams().couponId,c=GetParams().payMethod;$(".popupT").height(s);sessionStorage.setItem("goBackUrl",JSON.stringify(0)),1==JSON.parse(sessionStorage.getItem("isGoBack"))&&/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)?(sessionStorage.setItem("isGoBack",JSON.stringify(0)),window.location.reload()):function(){var t={couponId:l};$.post(h5orClient("/coupon/h5/baseinfo"),{data:JSON.stringify(t)},function(t){if(console.log(t),0==t.sc){if(d=t.data.priceType,void 0!=c&&"point"!=c||(d=1,$(".saleIntegral").show(),$(".saleIntegral a").attr("href","/html/order/virtualGoods.html?id=38607&mc=zqjf")),"cash"==c&&(d=0),$(".nameCons").html(t.data.couponName),$(".banner").attr("src",t.data.picUrl),$("#deadLine").html(newFormatStrDate(new Date(parseInt(t.data.expireTime)),"/")),n="micromessenger"!=u.match(/MicroMessenger/i)&&/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&/jihe/i.test(navigator.userAgent)?t.data.exchangeUrlApp:t.data.exchangeUrl,void 0!=t.data.productUsable){for(var o="<h3>可用商户及房型</h3>",i="",r=0;r<t.data.productUsable.length;r++)void 0!=t.data.productUsable[r].productUsableDesc?o+='<div class="sub-item"><h4>'+t.data.productUsable[r].hotelName+'</h4><div class="sub-content">'+t.data.productUsable[r].productUsableDesc+"</div></div>":o+='<div class="sub-item"><h4>'+t.data.productUsable[r].hotelName+"</h4></div>",i+='<li><a href="" class="clearfix"><div class="useHotelLeft fl">'+t.data.productUsable[r].hotelName+'</div><div class="useHotelRight fr"></div></a></li>';$("#productUsable").show().html(o),$("#applicableHotel").find(".useHotel").html(i)}void 0!=t.data.dateUsable&&$("#dateUsable").show().find("h3").html(t.data.dateUsable[0]),void 0!=t.data.bookCondition&&$("#bookCondition").show().find("h3").html(t.data.bookCondition[0]),void 0!=t.data.remark&&$("#remark").show().find("h3").html(t.data.remark),e(l),setInterval(function(){e(l)},8e3),a()}else $("#prompt").html("请稍后再试").show(),setTimeout(function(){$("#prompt").html("").hide()},2e3)})}(),void 0!=c&&"point"!=c||($("#yuan").hide(),$("#jf").show()),"cash"==c&&($("#jf").hide(),$("#yuan").show());var h;$("#buyMoney").val("").keyup(function(){o($("#buyMoney"),h,0,1e8)});var u=window.navigator.userAgent.toLowerCase();if($("input").focus(function(){$("html,body").animate({scrollTop:100})}),/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)){var p=$(".footer"),m=p.height(),f=$(document).height();$("input").focus(function(){setTimeout(function(){var t=$(window).scrollTop();startScrollY=t+f-260-m,$(".footer").css({position:"absolute",top:startScrollY,bottom:""}),$(window).bind("scroll",function(){var t=$(window).scrollTop();startScrollY=t+f-260-m,$(".footer").css({position:"absolute",top:startScrollY,bottom:""})})},50)}).blur(function(){$(".footer").css({position:"fixed",top:"inherit",bottom:"0"}),$(window).unbind("scroll")})}$(".buyAmount").click(function(){$("#buyMoney").focus()}),$(".backShadow,.popupTClose,.useKnow,#close,#iknow").click(function(){$(".popupT,#confirmEdu,#instructions,#applicableHotel,#checkAgain,#noIntegral").hide()}),$("#explainBtn").click(function(){$(".popupT,#instructions").show()}),$("#hotelBtn").click(function(){if("micromessenger"!=u.match(/MicroMessenger/i)&&/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&/jihe/i.test(navigator.userAgent)){var t={hotelUrl:encodeURIComponent(n),act:"toHotel"};i("http://www.jihelife.com?data="+JSON.stringify(t))}else window.location.href=n});$(".footRight,#goOn").click(function(){$(".footRight,#goOn").addClass("no");var t=$("#buyMoney").val(),o=$("#shouldPrice").html();if(t>0&&o>0){$(".footRight").addClass("no");var e={};$.post(h5orClient("/member/h5/info"),{data:JSON.stringify(e)},function(e){if(0==e.sc){if(parseInt(e.data.points)>=parseInt(o)||"cash"==GetParams().payMethod){var a={couponId:l,amount:Math.round(100*t),price:Math.round(100*o),priceType:d};void 0!=c&&"point"!=c||(a.price=o),"cash"==c&&(a.price=Math.round(100*o)),$.post(h5orClient("/trade/h5/buying/confirm"),{data:JSON.stringify(a)},function(t){if(console.log(t),0==t.sc){r=t.data.buyingId;window.navigator.userAgent.toLowerCase();void 0==t.data.productId||"-1"==t.data.productId?(void 0!=c&&"point"!=c||($("#oldPrice").html(o+"积分"),$("#newPrice").html(t.data.pointsPrice+"积分"),$("#shouldPrice").html(t.data.pointsPrice)),"cash"==c&&($("#oldPrice").html("￥"+o),$("#newPrice").html("￥"+floatFixed2(t.data.price/100)),$("#shouldPrice").html(floatFixed2(t.data.price/100))),$(".popupT,#checkAgain").show()):(sessionStorage.setItem("isGoBack",JSON.stringify(1)),void 0!=c&&"point"!=c||(window.location.href="/html/h5/order/payChannels.html?payMethod=point&data="+t.data.productId+"&buyingId="+r),"cash"==c&&(window.location.href="/html/h5/order/payChannels.html?data="+t.data.productId+"&buyingId="+r))}else $("#prompt").html("请稍后再试").show(),setTimeout(function(){$("#prompt").html("").hide()},2e3);$(".footRight,#goOn").removeClass("no")})}else $(".popupT,#noIntegral").show(),$("#buyIntegral").click(function(){window.location.href="/html/h5/product/detail/virtualGoods.html?id=38607&mc=zqjf"}),$(".footRight,#goOn").removeClass("no")}else $("#prompt").html("请稍后再试").show(),setTimeout(function(){$("#prompt").html("").hide()},2e3),$(".footRight,#goOn").removeClass("no")})}else $("#prompt").html("请输入购买额度").show(),setTimeout(function(){$("#prompt").html("").hide()},2e3),$(".footRight,#goOn").removeClass("no")});var g});