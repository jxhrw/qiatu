$(document).ready(function(){function t(t){var e;e=document.createElement("iframe"),e.setAttribute("src",t),e.setAttribute("style","display:none;"),document.body.appendChild(e),e.parentNode.removeChild(e)}function e(t,e,i){$(".payChannel li i").hasClass("current")?$.post(h5orClient("/order/h5/createandsubmit"),{data:JSON.stringify(t)},function(t){if(console.log(t),0==t.sc){o(t.data.orderid,e,i)}else"BASE-1002"==t.sc?($("#prompt").html("请稍后再试").show(),setTimeout(function(){$("#prompt").html("").hide()},2e3)):($("#prompt").html(t.ErrorMsg).show(),setTimeout(function(){$("#prompt").html("").hide()},2e3));$(".footerRight").removeClass("no")}):($("#prompt").html("请选择支付方式").show(),setTimeout(function(){$("#prompt").html("").hide()},2e3),$(".footerRight").removeClass("no"))}function o(e,o,i){var r,a={orderid:e,paychannel:i};r="micromessenger"!=b.match(/MicroMessenger/i)&&/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&/jihe/i.test(navigator.userAgent)?"/html/h5/order/dealDetail.html?app=jiheios&orderid="+e:"/html/h5/order/dealDetail.html?orderid="+e,$.post(h5orClient("/order/h5/pay"),{data:JSON.stringify(a)},function(a){if(0==a.sc)if(null!=a.data.payTicketInfo)if(console.log(a.data.payTicketInfo),"jh"==a.data.payTicketInfo.channel){var n={chargeId:a.data.payTicketInfo.chargeId,tradeToken:o};$.post(h5orClient("/pay/h5/balance/confirmCharge"),{data:JSON.stringify(n)},function(e){if(console.log(e),-1!=y.indexOf("Detail"))window.history.go(-1);else{if("micromessenger"!=b.match(/MicroMessenger/i)&&/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&/jihe/i.test(navigator.userAgent)){t('http://www.jihelife.com?data={"backPage":"2"}')}window.location.href=r}$(".footerRight").removeClass("no")})}else if("micromessenger"!=b.match(/MicroMessenger/i)&&/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&/jihe/i.test(navigator.userAgent)){if(-1!=y.indexOf("Detail")){var s='{"orderid":"'+e+'","paychannel":"'+i+'","act":"toPay","orderUrl":"-1","backPage":"2"}',d="http://www.jihelife.com?data="+s;t(d),console.log(d)}else{var l="http://"+window.location.host+r,c='{"orderid":"'+e+'","paychannel":"'+i+'","act":"toPay","orderUrl":"'+encodeURIComponent(l)+'","backPage":"2"}',h="http://www.jihelife.com?data="+c;t(h),console.log(h)}$(".footerRight").removeClass("no")}else pingpp.createPayment(a.data.payTicketInfo,function(t,o){console.log(t),"cancel"==t?$.post("/order/h5/breakpay/"+e,function(t){console.log(t),0==t.sc&&(-1!=y.indexOf("Detail")?window.history.go(-1):window.location.href=r)}):"success"==t&&(-1!=y.indexOf("Detail")?window.history.go(-1):window.location.href=r)}),$(".footerRight").removeClass("no");else-1!=y.indexOf("Detail")?window.history.go(-1):window.location.href=r;else"BASE-1002"==a.sc?($("#prompt").html("请选择支付方式").show(),setTimeout(function(){$("#prompt").html("").hide()},2e3),$(".footerRight").removeClass("no")):($("#prompt").html(a.ErrorMsg).show(),setTimeout(function(){$("#prompt").html("").hide()},2e3),$(".footerRight").removeClass("no"))})}function i(t){if($("#countdown").html(n(t)),t>0)var e=setInterval(function(){t--,$("#countdown").html(n(t)),0==t&&(clearInterval(e),$(".popupTGoBack,#goBackBox").show(),$(".footerRight").addClass("no").addClass("grey"),$(".footerRight img,.footerRight span").hide())},1e3);else $(".popupTGoBack,#goBackBox").show(),$(".footerRight").addClass("no").addClass("grey"),$(".footerRight img,.footerRight span").hide()}function r(t,e){$("#setButton,.checkForget").click(function(){$("#digital").remove(),$(".checkPsword").hide(),$(".popupT,.setPsword").hide(),m(),$("#owner").html(e),$("#phoneNum").html(t.substr(0,3)+"****"+t.substr(7,4)),$(".popupT,.textPs").show(),O="setButton"==$(this).attr("id")?0:1})}function a(){$("#sure").click(function(){var t=$(".SMSVer input").val(),e={verifycode:t};$.post(h5orClient("/user/h5/checkverifycode"),{data:JSON.stringify(e)},function(e){console.log(e);var o;0==O?o=1:1==O&&(o=2),"0"==e.sc?(-1!=y.indexOf("Detail")?sessionStorage.setItem("createData",JSON.stringify(GetParams().orderid)):sessionStorage.setItem("createData",JSON.stringify(M)),sessionStorage.setItem("goHttp",JSON.stringify(O)),"micromessenger"==b.match(/MicroMessenger/i)?window.location.href="/html/h5/member/personinfo/password.html?type="+o+"&verifycode="+t:(/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&(window.location.href="/html/h5/member/personinfo/password.html?type="+o+"&verifycode="+t,/jihe/i.test(navigator.userAgent)&&(window.location.href="/html/h5/member/personinfo/password.html?app=jiheios&type="+o+"&verifycode="+t)),/android/i.test(navigator.userAgent)&&(window.location.href="/html/h5/member/personinfo/password.html?type="+o+"&verifycode="+t))):($("#prompt").html("验证码错误").show(),setTimeout(function(){$("#prompt").hide()},2e3))})})}function n(t){return minutes=parseInt(t/60),seconds=parseInt(t%60),formatNum(minutes)+":"+formatNum(seconds)}function s(t){$(t).find("td").css({"border-color":"#9b9b9b"});for(var e=0;e<$(t).find("td").length;e++){if(""==$(t).find("td").eq(e).html())return void $(t).find("td").eq(e).css({"border-color":"#000"});$(t).find("td").eq(e).css({"border-color":"#000"})}}function d(t,e,o,i,r,a){$(e).html('<table id="digital" cellpadding="0" cellspacing="0" width="100%"><tr><td>1</td><td>2</td><td>3</td></tr><tr><td>4</td><td>5</td><td>6</td></tr><tr><td>7</td><td>8</td><td>9</td></tr><tr><td style="background-color: #d2d5db;"></td><td>0</td><td id="delete"><em></em></td></tr></table>'),$("#delete").css({background:"#d2d5db"}).find("em").css({background:"url(/html/member/images/delete.jpg) no-repeat center/contain",display:"inline-block",width:"1.53rem",height:"1.13rem"}),$("#digital").css({"text-align":"center","font-size":"1.4rem","table-layout":"fixed"}).find("td").css({"border-right":"1px solid #8c8c8c","border-bottom":"1px solid #8c8c8c",padding:"1rem 0",cursor:"pointer","-moz-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","-khtml-user-select":"none","user-select":"none"}),$("#digital tr td:last-child").css({"border-right":"0"}),$("#digital tr:last-child td").css({"border-bottom":"0"}),$("#digital td").on("touchstart",function(){if("delete"!=$(this).attr("id"))l(this,t,o,i,r,a);else if("table"==i){$(a).addClass("no");for(var e=$(t).find("td").length-1;e>=0;e--)if($(t).find("td").eq(e).html())return $(t).find("td").eq(e).html("").removeAttr("value"),void s("#inputPassword")}else{var n=$(t).html(),d=$(t).attr("value")?$(t).attr("value"):"";n.length<=1?$(t).html("").removeAttr("value"):(n=n.substr(0,n.length-1),d=d.substr(0,d.length-1),$(t).html(n).attr("value",d))}s("#inputPassword")})}function l(t,e,o,i,r,a){var n=$(t).html(),s="<div class='star'>*</div>";if(""!=n)if("table"==i){for(var d=0;d<$(e).find("td").length&&d<o;d++)if(!$(e).find("td").eq(d).html())return"password"==r?$(e).find("td").eq(d).html(s).attr("value",n):$(e).find("td").eq(d).html(n),void(d==o-1&&h(a))}else{var l=$(e).html(),c=$(e).attr("value")?$(e).attr("value"):"";(l.length<o||void 0==o)&&("password"==r?$(e).html(l+s).attr("value",c+n):$(e).html(l+n),(l+n).length==o&&h(a))}}function c(t,e,o){var i="";return"table"==e?"password"==o?$(t).find("td").each(function(){i+=$(this).attr("value")?$(this).attr("value"):""}):$(t).find("td").each(function(){i+=$(this).html()}):i="password"==o?$(t).attr("value")?$(t).attr("value"):"":$(t).html(),i}function h(t){$(t).removeClass("no")}function m(){if(0==w){var t={verifycodetype:2};$("#again").addClass("no");$.post(h5orClient("/user/h5/getverifycode"),{data:JSON.stringify(t)},function(t){console.log(t)}),w=60;var e=setInterval(function(){w--,$("#again").html(w+"S"),0==w&&($("#again").html("重新发送").removeClass("no"),clearInterval(e))},1e3)}}var p,u,f,g=$(window).height(),w=(GetParams().couponId,0),v=0,y=document.referrer,b=window.navigator.userAgent.toLowerCase(),P="",k="",C=sessionStorage.getItem("backPage_payChannels");$(".popupT,.popupTGoBack").height(g);var S=JSON.parse(sessionStorage.getItem("goBackUrl"));2==S&&"-1"==document.referrer.indexOf("Detail")&&(C="-2"==C?-2:-1,sessionStorage.setItem("backPage_payChannels","-1"),window.history.go(C)),S=0,sessionStorage.setItem("goBackUrl",JSON.stringify(S));var O;if(1==(O=JSON.parse(sessionStorage.getItem("goHttp")))){O=0,sessionStorage.setItem("goHttp",JSON.stringify(O));var I=JSON.parse(sessionStorage.getItem("createData"));void 0!=JSON.parse(sessionStorage.getItem("tradeToken"))&&(P="jh","object"==typeof I&&e(I,JSON.parse(sessionStorage.getItem("tradeToken")),P),"string"==typeof I&&o(I,JSON.parse(sessionStorage.getItem("tradeToken")),P))}else O=0,sessionStorage.setItem("goHttp",JSON.stringify(O));P="";var T,N,x,J,A={id:GetParams().data};$.post(h5orClient("/product/h5/query"),{data:JSON.stringify(A)},function(t){if(console.log(t),0==t.sc){f=t.data.productPrice.priceType,x=t.data.referPrice;var e=t.data.payChannelList,o=floatFixed2(t.data.productPrice.totalPrice/100),r=t.data.productPrice.totalPointPrice;if(u=o,T=t.data.productPrice.totalPrice,N=r,$(".productName").html(t.data.productName),$("#quota").html(x),$("#discount").html(Math.ceil(o/x*100)+"%"),$("#subRatio").html("1："+Math.ceil(r/x*10)/10),$("#payMoney").html("￥"+o),0==f){$("#subRatio").parents("li").hide(),$("#payMoney2").html("￥"+o);for(var a=0;void 0!=e&&a<e.length;a++){if("micromessenger"!=window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i)&&/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&/jihe/i.test(navigator.userAgent)?("alipay"==e[a]&&$(".payChannel,#alipay").show().click(),"wx"==e[a]&&$(".payChannel,#wx").show()):"wx_pub"==e[a]&&$(".payChannel,#wx_pub").show().click(),"jh"==e[a]){var n={};$.post(h5orClient("/pay/h5/balance/info"),{data:JSON.stringify(n)},function(t){0==t.sc&&(p=floatFixed2(t.data.cashBalance/100),$("#remain").html("￥"+p))})}}}if(1==f&&($("#discount").parents("li").hide(),$("#payMoney2").html(r+"积分"),$(".payChannel,#jf").hide().click()),void 0==GetParams().orderid&&void 0!=GetParams().buyingId&&setTimeout(function(){!function(){var t={title:"",url:""};sessionStorage.setItem("backPage_payChannels","-2"),window.history.pushState(t,"","")}(),window.addEventListener("popstate",function(t){var e={buyingId:GetParams().buyingId};$.post(h5orClient("/trade/h5/buying/cancel"),{data:JSON.stringify(e)},function(t){console.log(t),t.sc,window.history.go(-1)})},!1)},2e3),void 0!=GetParams().orderid){var s={orderid:GetParams().orderid};$.post(h5orClient("/order/h5/info"),{data:JSON.stringify(s)},function(t){console.log(t),0==t.sc&&(J=parseInt(t.data.countDown),i(J))})}else J=parseInt(t.data.countdown),i(J)}else $("#prompt").html(t.ErrorMsg).show(),setTimeout(function(){$("#prompt").html("").hide()},2e3)}),$(".payChannel li").click(function(){if("jh"==$(this).attr("id")&&u>p)return $("#prompt").html("您的余额不足").show(),void setTimeout(function(){$("#prompt").html("").hide()},2e3);$("i",this).hasClass("current")?($("i",this).removeClass("current").html("&#xe62c"),P=""):($(".payChannel li i").removeClass("current").html("&#xe62c"),$("i",this).addClass("current").html("&#xe619;"),P=$(this).attr("id")),k=($(this).attr("id"),"0")});var M;$(".footerRight").click(function(){$(".footerRight").addClass("no");var t;if(0==f&&(t=[{amount:T,paytype:k}],M={productid:GetParams().data,amount:T,payments:t}),1==f&&(t=[{paytype:6,points:N}],M={productid:GetParams().data,amount:Math.round(100*T),pointamount:N,payments:t}),"jh"==P){var i,n,l={};$.post(h5orClient("/user/h5/existtradepasswd"),{data:JSON.stringify(l)},function(t){0==t.sc?(i=t.data.mobileAccount,n=t.data.realName,"1"==t.data.existTradePasswd&&($(".popupT,.checkPsword").show(),s("#inputPassword"),d("#inputPassword",".keyboard","6","table","password",".button"),r(i,n),a()),"0"==t.data.existTradePasswd&&($(".popupT,.setPsword").show(),0==v&&(r(i,n),$("#again").click(function(){m()}),a(),v++))):($("#prompt").html(t.ErrorMsg).show(),setTimeout(function(){$("#prompt").html("").hide()},2e3)),$(".footerRight").removeClass("no")})}else-1!=window.location.href.indexOf("orderid")?o(GetParams().orderid,"",P):e(M,"",P)}),$("#checkBtn").click(function(){$("#checkBtn").addClass("no");var t={tradepasswd:c("#inputPassword","table","password")};$.post(h5orClient("/user/h5/checktradepasswd"),{data:JSON.stringify(t)},function(t){console.log(t),0==t.sc?-1!=window.location.href.indexOf("orderid")?o(GetParams().orderid,t.data.tradeToken,P):e(M,t.data.tradeToken,P):($(".checkTitle p").html("密码错误"),$("#inputPassword").find("td").css({"border-color":"#9b9b9b"}).html("").removeAttr("value"))})}),$(".backShadow,#checkClose").click(function(){$(".checkTitle p").html("&nbsp;"),$(".popupT,.checkPsword,.textPs,.setPsword").hide(),$("#inputPassword").find("td").css({"border-color":"#9b9b9b"}).html("").removeAttr("value")}),$(".backShadowGoBack,#goBack").click(function(){window.history.go(-1)})});