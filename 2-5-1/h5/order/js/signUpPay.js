$(document).ready(function(){$(".screenBox,.screenFull").height($(window).height());$("#winResults").click(function(){$("#winningList").show()});$(".shadow,.close").click(function(){$(".screenFull").hide()});$(".plus:last-child").css("display","none");var a,b,c,d;var e=GetParams().id;var f;var g="{'id':"+e+"}";$.ajax({url:"/product/h5/query",type:'POST',data:{data:g},dataType:'json',success:function(h){console.log(h);a=h.data.productPrice.totalPrice;b=h.data.serviceUrl;c=h.data.productDesc;d=h.data.imgList[0];f=h.data.payTypes[0];document.title=h.data.productName;$(".activityName").html(h.data.productName);$(".bannerBgp").css("background-img",'url('+d+')');$(".activityPrize").html(c);if(f==0){$("#price").html(parseInt(h.data.productPrice.totalPrice/100))};if(f==4){$("#payWeChat").html(parseInt(h.data.productPrice.totalPointPrice)+" 积分支付").css("text-align","center")}},error:function(h){console.log(h.status)}});$("#payWeChat").click(function(){$("#payWeChat").css({"pointer-events":"none"});setTimeout(function(){$("#payWeChat").css({"pointer-events":""})},5000);createAndPayServiceOrder(e,a,b,f)});function createAndPayServiceOrder(h,i,j,k){queryParam={'productid':h};$.post("/order/h5/list",{data:JSON.stringify(queryParam)},function(l,m){var n=null;if("0"==l.sc&&l.data.length>0){for(var o=0;o<l.data.length;o++){if(2==l.data[o].paystatus){window.location.href=j;return};if(9!=l.data[o].status){n=l.data[o];break}};$("#payWeChat").css({"pointer-events":""})};if(null!=n){if(k==0){payParam={"orderid":n.orderid,'paychannel':'wx_pub2'}};if(k==4){payParam={"orderid":n.orderid};var o=confirm("确认支付吗？");if(o!=true){return}};$.post("/order/h5/pay",{data:JSON.stringify(payParam)},function(o,p){if("0"==o.sc){var q=o.data.orderid;if(null!=o.data.payTicketInfo){pingpp.createPayment(o.data.payTicketInfo,function(r,s){if("cancel"==r){$.post('/order/h5/breakpay/'+q,function(t,u){console.log(t)})}else if("success"==r){checkPayStatus(q,j)}})}else{window.location.href=j}}else if("ORDER-1006"==o.sc){window.location.href=j}else{errorPrompt(chinese(o.ErrorMsg),2000)};$("#payWeChat").css({"pointer-events":""})})}else{if(k==0){createParam={'productid':h,'quantity':1,'amount':i,'payments':[{'paytype':0,'amount':i}],'paychannel':'wx_pub2'}};if(k==4){createParam={'productid':h,'quantity':1,'amount':i,'payments':[{'paytype':4,'amount':i,'points':i/8}]};var o=confirm("确认支付吗？");if(o!=true){return}};$.post("/order/h5/createandpay",{data:JSON.stringify(createParam)},function(o,p){console.log(o);if(o.sc=="0"){var q=o.data.orderid;if(null!=o.data.payTicketInfo){pingpp.createPayment(o.data.payTicketInfo,function(r,s){console.log(r);console.log(s);if("cancel"==r){$.post('/order/h5/breakpay/'+q,function(t,u){console.log(t)})}else if("success"==r){checkPayStatus(q,j)}})}else{window.location.href=j}}else if("ORDER-1010"==o.sc){window.location.href=j}else{errorPrompt(chinese(o.ErrorMsg),2000)};$("#payWeChat").css({"pointer-events":""})})}})};function checkPayStatus(h,i){var j={"orderid":h};setTimeout(function(){$.post('/order/h5/info',{data:JSON.stringify(j)},function(k,l){if("0"==k.sc&&"2"==k.data.paystatus&&"9"!=k.data.status){console.log(k);window.location.href=i}else{console.log(k)};$("#payWeChat").css({"pointer-events":""})})},1000)}});